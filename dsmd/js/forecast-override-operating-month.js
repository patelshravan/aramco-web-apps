var response = {
  status: [
    {
      RUN_FORECAST_UPDATE_BY: "unxsas",
      RUN_FORECAST_UPDATE_DTTM: "  16APR2023:16:04:50",
      SAVE_OVERRIDE_UPDATE_BY: "unxsas",
      SAVE_OVERRIDE_UPDATE_DTTM: "  16APR2023:16:05:44",
      OVERRIDE_UPDATE_IN_SAP_BY: "unxsas",
      FORECAST_LEVEL: "LCL",
      OVERRIDE_UPDATE_IN_SAP_DTTM: "  16APR2023:16:06:25",
    },
  ],
  data: [
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "LCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: 34,
      DAY_2: 34,
      DAY_3: 29,
      DAY_4: 34,
      DAY_5: 34,
      DAY_6: 34,
      DAY_7: 34,
      DAY_8: 31,
      DAY_9: 34,
      DAY_10: 34,
      DAY_11: 31,
      DAY_12: 31,
      DAY_13: 18,
      DAY_14: 34,
      DAY_15: 34,
      DAY_16: 34,
      DAY_17: 34,
      DAY_18: 33,
      DAY_19: 32,
      DAY_20: 34,
      DAY_21: 34,
      DAY_22: 34,
      DAY_23: 34,
      DAY_24: 34,
      DAY_25: 32,
      DAY_26: 32,
      DAY_27: 27,
      DAY_28: 34,
      DAY_29: 34,
      DAY_30: 34,
      DAY_31: 34,
    },
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "NORMAL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: 32.3,
      DAY_2: 28.5,
      DAY_3: 32.3,
      DAY_4: 32.3,
      DAY_5: 32.3,
      DAY_6: 32.3,
      DAY_7: 32.3,
      DAY_8: 32.3,
      DAY_9: 27.55,
      DAY_10: 32.3,
      DAY_11: 29.45,
      DAY_12: 18.05,
      DAY_13: 30.4,
      DAY_14: 18.05,
      DAY_15: 32.3,
      DAY_16: 31.35,
      DAY_17: 31.35,
      DAY_18: 32.3,
      DAY_19: 32.3,
      DAY_20: 31.35,
      DAY_21: 32.3,
      DAY_22: 32.3,
      DAY_23: 32.3,
      DAY_24: 32.3,
      DAY_25: 32.3,
      DAY_26: 32.3,
      DAY_27: 32.3,
      DAY_28: 32.3,
      DAY_29: 32.3,
      DAY_30: 32.3,
      DAY_31: 32.3,
    },
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "UCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: 31.5,
      DAY_2: 31.5,
      DAY_3: 30.45,
      DAY_4: 35.7,
      DAY_5: 35.7,
      DAY_6: 35.7,
      DAY_7: 35.7,
      DAY_8: 35.7,
      DAY_9: 35.7,
      DAY_10: 27.3,
      DAY_11: 35.7,
      DAY_12: 32.55,
      DAY_13: 35.7,
      DAY_14: 29.4,
      DAY_15: 35.7,
      DAY_16: 35.7,
      DAY_17: 35.7,
      DAY_18: 35.7,
      DAY_19: 33.6,
      DAY_20: 35.7,
      DAY_21: 35.7,
      DAY_22: 35.7,
      DAY_23: 35.7,
      DAY_24: 33.6,
      DAY_25: 35.7,
      DAY_26: 33.6,
      DAY_27: 35.7,
      DAY_28: 35.7,
      DAY_29: 35.7,
      DAY_30: 35.7,
      DAY_31: 35.7,
    },
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "USER_OVERRIDE",
      FORECAST_LEVEL: "UCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: null,
      DAY_2: null,
      DAY_3: null,
      DAY_4: null,
      DAY_5: 30,
      DAY_6: null,
      DAY_7: null,
      DAY_8: null,
      DAY_9: null,
      DAY_10: 40,
      DAY_11: null,
      DAY_12: null,
      DAY_13: null,
      DAY_14: null,
      DAY_15: null,
      DAY_16: null,
      DAY_17: null,
      DAY_18: null,
      DAY_19: null,
      DAY_20: null,
      DAY_21: null,
      DAY_22: null,
      DAY_23: null,
      DAY_24: null,
      DAY_25: null,
      DAY_26: null,
      DAY_27: null,
      DAY_28: null,
      DAY_29: null,
      DAY_30: null,
      DAY_31: null,
    },
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "LCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: 34,
      DAY_2: 34,
      DAY_3: 29,
      DAY_4: 34,
      DAY_5: 34,
      DAY_6: 34,
      DAY_7: 34,
      DAY_8: 31,
      DAY_9: 34,
      DAY_10: 34,
      DAY_11: 31,
      DAY_12: 31,
      DAY_13: 18,
      DAY_14: 34,
      DAY_15: 34,
      DAY_16: 34,
      DAY_17: 34,
      DAY_18: 33,
      DAY_19: 32,
      DAY_20: 34,
      DAY_21: 34,
      DAY_22: 34,
      DAY_23: 34,
      DAY_24: 34,
      DAY_25: 32,
      DAY_26: 32,
      DAY_27: 27,
      DAY_28: 34,
      DAY_29: 34,
      DAY_30: 34,
      DAY_31: 34,
    },
    {
      PRODUCT_ID: "Z-999",
      CUSTOMER_ID: "500613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "KMYA",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "NORMAL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: 32.3,
      DAY_2: 28.5,
      DAY_3: 32.3,
      DAY_4: 32.3,
      DAY_5: 32.3,
      DAY_6: 32.3,
      DAY_7: 32.3,
      DAY_8: 32.3,
      DAY_9: 27.55,
      DAY_10: 32.3,
      DAY_11: 29.45,
      DAY_12: 18.05,
      DAY_13: 30.4,
      DAY_14: 18.05,
      DAY_15: 32.3,
      DAY_16: 31.35,
      DAY_17: 31.35,
      DAY_18: 32.3,
      DAY_19: 32.3,
      DAY_20: 31.35,
      DAY_21: 32.3,
      DAY_22: 32.3,
      DAY_23: 32.3,
      DAY_24: 32.3,
      DAY_25: 32.3,
      DAY_26: 32.3,
      DAY_27: 32.3,
      DAY_28: 32.3,
      DAY_29: 32.3,
      DAY_30: 32.3,
      DAY_31: 32.3,
    },
    {
      PRODUCT_ID: "Z-888",
      CUSTOMER_ID: "400613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "SDAF",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "LCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: null,
      DAY_2: null,
      DAY_3: null,
      DAY_4: null,
      DAY_5: null,
      DAY_6: null,
      DAY_7: null,
      DAY_8: null,
      DAY_9: null,
      DAY_10: 2.85,
      DAY_11: 0,
      DAY_12: 9.5,
      DAY_13: 9.5,
      DAY_14: 7.6,
      DAY_15: 8.55,
      DAY_16: 7.6,
      DAY_17: 7.6,
      DAY_18: 7.6,
      DAY_19: 8.55,
      DAY_20: 9.5,
      DAY_21: 8.55,
      DAY_22: 7.6,
      DAY_23: 11.4,
      DAY_24: 8.55,
      DAY_25: 8.55,
      DAY_26: 9.5,
      DAY_27: 6.65,
      DAY_28: 4.75,
      DAY_29: null,
      DAY_30: null,
      DAY_31: null,
    },
    {
      PRODUCT_ID: "Z-888",
      CUSTOMER_ID: "400613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "SDAF",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "NORMAL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: null,
      DAY_2: null,
      DAY_3: null,
      DAY_4: null,
      DAY_5: null,
      DAY_6: null,
      DAY_7: null,
      DAY_8: null,
      DAY_9: null,
      DAY_10: 3,
      DAY_11: 0,
      DAY_12: 10,
      DAY_13: 10,
      DAY_14: 8,
      DAY_15: 9,
      DAY_16: 8,
      DAY_17: 8,
      DAY_18: 8,
      DAY_19: 9,
      DAY_20: 10,
      DAY_21: 9,
      DAY_22: 8,
      DAY_23: 12,
      DAY_24: 9,
      DAY_25: 9,
      DAY_26: 10,
      DAY_27: 7,
      DAY_28: 5,
      DAY_29: null,
      DAY_30: null,
      DAY_31: null,
    },
    {
      PRODUCT_ID: "Z-888",
      CUSTOMER_ID: "400613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "SDAF",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "FORECASTED",
      FORECAST_LEVEL: "UCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: null,
      DAY_2: null,
      DAY_3: null,
      DAY_4: null,
      DAY_5: null,
      DAY_6: null,
      DAY_7: null,
      DAY_8: null,
      DAY_9: null,
      DAY_10: 3.15,
      DAY_11: 0,
      DAY_12: 10.5,
      DAY_13: 10.5,
      DAY_14: 8.4,
      DAY_15: 9.45,
      DAY_16: 8.4,
      DAY_17: 8.4,
      DAY_18: 8.4,
      DAY_19: 9.45,
      DAY_20: 10.5,
      DAY_21: 9.45,
      DAY_22: 8.4,
      DAY_23: 12.6,
      DAY_24: 9.45,
      DAY_25: 9.45,
      DAY_26: 10.5,
      DAY_27: 7.35,
      DAY_28: 5.25,
      DAY_29: null,
      DAY_30: null,
      DAY_31: null,
    },
    {
      PRODUCT_ID: "Z-888",
      CUSTOMER_ID: "400613",
      PRODUCT: "PROPANE",
      REGION: "EAST",
      CUSTOMER_NAME: "SDAF",
      DOMESTIC_CUSTOMER_GROUP: "SABIC",
      SUBJECT: "USER_OVERRIDE",
      FORECAST_LEVEL: "UCL",
      PLANNING_MONTH: "MAR2023",
      DAY_1: null,
      DAY_2: null,
      DAY_3: null,
      DAY_4: 20,
      DAY_5: null,
      DAY_6: null,
      DAY_7: null,
      DAY_8: 50,
      DAY_9: null,
      DAY_10: null,
      DAY_11: null,
      DAY_12: null,
      DAY_13: null,
      DAY_14: null,
      DAY_15: null,
      DAY_16: null,
      DAY_17: null,
      DAY_18: null,
      DAY_19: null,
      DAY_20: null,
      DAY_21: null,
      DAY_22: null,
      DAY_23: null,
      DAY_24: null,
      DAY_25: null,
      DAY_26: null,
      DAY_27: null,
      DAY_28: null,
      DAY_29: null,
      DAY_30: null,
      DAY_31: null,
    },
  ],
};

var isTesting = true;
var isPlanningMonth = false;

let forecastLevels = ["NORMAL", "LCL", "UCL"];
let customerGroups = ["SABIC", "NON-SABIC", "SAUDI ARAMCO"];

const products = ["PROPANE", "BUTANE", "NGL"];

const tabs = [
  {
    id: 0,
    text: "EAST",
    content: "User tab content",
  },
  {
    id: 1,
    text: "WEST",
    content: "Comment tab content",
  },
];

const baseurl = "https://cs-action.aramco.com/SASJobExecution";
//const baseurl = "https://cs-action.aramco.com/SASJobExecution";

let { year, futureMonthName, monthName, shortMonth, shortFutureMonth } =
  getActiveMonth();
// let readMonth = "APR2023"
let readMonth =
  (isPlanningMonth
    ? shortFutureMonth?.toUpperCase()
    : shortMonth?.toUpperCase()) + year;

const forecastListBaseUrl = `${baseurl}/?_program=%2FSTSP%20LPG%20Demand%20Forecasting%2FCodes%2FWeb%20Interface%2FAPI%20Jobs%2FAPI%20Domestic_Demand_Over_Screen%20-%20READ&MONTH=${readMonth}`;

const saveOverrideUrl = `${baseurl}/?_program=%2FSTSP%20LPG%20Demand%20Forecasting%2FCodes%2FWeb%20Interface%2FAPI%20Jobs%2FUpdate_Domestic_Demand_Save_Overrides_API&MONTH=${readMonth}`;

const runForecastUrl = `${baseurl}/?_program=%2FSTSP%20LPG%20Demand%20Forecasting%2FCodes%2FWeb%20Interface%2FAPI%20Jobs%2FUpdate_Domestic_Demand_Run_Forecast_API&MONTH=${readMonth}`;
const updateSapUrl = `${baseurl}/?_program=%2FSTSP%20LPG%20Demand%20Forecasting%2FCodes%2FWeb%20Interface%2FAPI%20Jobs%2FUpdate_Domestic_Demand_Update_In_SAP_API&MONTH=${readMonth}`;

function getActiveMonth() {
  let year = moment().format("YYYY");
  let monthName = moment().format("MMMM");
  let futureMonthName = moment().add(1, "month").format("MMMM");
  return {
    year,
    futureMonthName,
    monthName,
    shortMonth: moment().format("MMM"),
    shortFutureMonth: moment().add(1, "month").format("MMM"),
  };
}
function setHeaderDate() {
  var planningMonth =
    (isPlanningMonth ? futureMonthName : monthName) + " " + year;
  $("#datepicker1").html(" - " + planningMonth);
}

$(() => {
  const regionTabs = $("#region-tabs > .tabs-container")
    .dxTabs({
      dataSource: tabs,
      selectedIndex: 0,
      animationEnabled: true,
      swipeEnabled: true,
      onItemClick(e) {
        regionTabs.option("selectedIndex", e.itemData.id);
        handleFilter();
      },
    })
    .dxTabs("instance");

  setHeaderDate();

  //     Filter dropdowns

  let productFilter = $("#productFilter")
    .dxSelectBox({
      items: products,
      value: products[0],
      placeholder: "Choose Product",
      onValueChanged(data) {
        handleFilter();
      },
    })
    .dxSelectBox("instance");
  let forecastLvlFilter = $("#forecastLvlFilter")
    .dxSelectBox({
      items: forecastLevels,
      value: forecastLevels[0],
      onValueChanged(data) {
        handleFilter();
      },
    })
    .dxSelectBox("instance");
  let customerGrpFilter = $("#customerGrpFilter")
    .dxSelectBox({
      items: customerGroups,
      value: customerGroups[0],
      onValueChanged(data) {
        handleFilter();
      },
    })
    .dxSelectBox("instance");

  // Grid code
  getData();

  var subjects = {
    Override: "USER_OVERRIDE",
    Forecasted: "FORECASTED",
    FinalForecast: "FINALFORECAST",
  };

  function setStatus(status) {
    $("#lastForecastDate").text(status.RUN_FORECAST_UPDATE_DTTM);
    $("#lastSaveDate").text(status.SAVE_OVERRIDE_UPDATE_DTTM);
    $("#lastUpdateDate").text(status.OVERRIDE_UPDATE_IN_SAP_DTTM);
  }

  function handleResp(resp) {
    if (resp?.data) {
      response = resp;
      let list = resp?.data;
      let status = resp?.status?.[0] || {};
      setStatus(status);

      list = formatList(list);

      addMissingCols(list);

      overrideGrid.option("dataSource", list);
      handleFilter();
    }
  }
  async function getData() {
    try {
      let url = forecastListBaseUrl;
      let resp = await sendRequest(`${url}`, "GET");

      // sort data
      const data = resp.data;

      data.sort((a, b) => {
        // Sort by SUBJECT column in the order "FORECASTED" and "USER_OVERRIDE"
        const subjectOrder = {
          FORECASTED: 0,
          USER_OVERRIDE: 1,
        };
        const subjectA = a.SUBJECT;
        const subjectB = b.SUBJECT;
        if (subjectOrder[subjectA] < subjectOrder[subjectB]) {
          return -1;
        }
        if (subjectOrder[subjectA] > subjectOrder[subjectB]) {
          return 1;
        }

        // Sort by FORECAST_LEVEL column in the order "NORMAL", "LCL", and "UCL" of "FORECASTED"
        if (subjectA === "FORECASTED" && subjectB === "FORECASTED") {
          const forecastLevelOrder = {
            NORMAL: 0,
            LCL: 1,
            UCL: 2,
          };
          const forecastLevelA = a.FORECAST_LEVEL;
          const forecastLevelB = b.FORECAST_LEVEL;
          if (
            forecastLevelOrder[forecastLevelA] <
            forecastLevelOrder[forecastLevelB]
          ) {
            return -1;
          }
          if (
            forecastLevelOrder[forecastLevelA] >
            forecastLevelOrder[forecastLevelB]
          ) {
            return 1;
          }
        }

        return 0;
      });

      // Assign the sorted data back to "data.data"
      data.data = data;

      handleResp(data);
    } catch (err) {
      const data = response.data;

      data.sort((a, b) => {
        // Sort by SUBJECT column in the order "FORECASTED" and "USER_OVERRIDE"
        const subjectOrder = {
          FORECASTED: 0,
          USER_OVERRIDE: 1,
        };
        const subjectA = a.SUBJECT;
        const subjectB = b.SUBJECT;
        if (subjectOrder[subjectA] < subjectOrder[subjectB]) {
          return -1;
        }
        if (subjectOrder[subjectA] > subjectOrder[subjectB]) {
          return 1;
        }

        // Sort by FORECAST_LEVEL column in the order "NORMAL", "LCL", and "UCL" of "FORECASTED"
        if (subjectA === "FORECASTED" && subjectB === "FORECASTED") {
          const forecastLevelOrder = {
            NORMAL: 0,
            LCL: 1,
            UCL: 2,
          };
          const forecastLevelA = a.FORECAST_LEVEL;
          const forecastLevelB = b.FORECAST_LEVEL;
          if (
            forecastLevelOrder[forecastLevelA] <
            forecastLevelOrder[forecastLevelB]
          ) {
            return -1;
          }
          if (
            forecastLevelOrder[forecastLevelA] >
            forecastLevelOrder[forecastLevelB]
          ) {
            return 1;
          }
        }

        return 0;
      });

      // Assign the sorted data back to "data.data"
      data.data = data;

      console.log("error in handleFilter api", err);
      $(".overlay").hide();

      isTesting && handleResp(data); // testing
    }
  }
  async function handleFilterOld() {
    let params = {
      Region: regionTabs.option("selectedItem")?.text,
      Product: productFilter.option("selectedItem"),
      Domestic_Customr_Group: customerGrpFilter.option("selectedItem"),
    };

    let list = overrideGrid.option("dataSource");
    // 1 steps to filter - 1. apply filter to get required list
    list = list?.filter((itemData, i, arr) => {
      let {
        SUBJECT,
        REGION,
        FORECAST_LEVEL,
        PRODUCT,
        DOMESTIC_CUSTOMER_GROUP,
        CUSTOMER_ID,
      } = itemData || {};
      let isTrue =
        REGION == params.Region &&
        PRODUCT == params.Product &&
        DOMESTIC_CUSTOMER_GROUP == params.Domestic_Customr_Group;
      if (isTrue && SUBJECT == subjects.Forecasted) return isTrue;
    });

    // step 2. apply filter to Actual grid datasource to obtain filtered list along
    overrideGrid.filter(function (itemData) {
      let {
        REGION,
        FORECAST_LEVEL,
        PRODUCT,
        DOMESTIC_CUSTOMER_GROUP,
        CUSTOMER_ID,
        SUBJECT,
      } = itemData || {};

      let finder = list?.some((obj) => obj?.CUSTOMER_ID == CUSTOMER_ID);
      if (finder && SUBJECT !== subjects.Override) {
        finder =
          REGION == params.Region &&
          PRODUCT == params.Product &&
          DOMESTIC_CUSTOMER_GROUP == params.Domestic_Customr_Group;
      }
      return finder;
    });
  }
  async function handleFilter() {
    let params = {
      Region: regionTabs.option("selectedItem")?.text,
      Product: productFilter.option("selectedItem"),
      Domestic_Customr_Group: customerGrpFilter.option("selectedItem"),
    };

    let list = overrideGrid.option("dataSource");
    console.log("params", params);
    overrideGrid.filter(function (itemData) {
      let {
        REGION,
        FORECAST_LEVEL,
        PRODUCT,
        DOMESTIC_CUSTOMER_GROUP,
        CUSTOMER_ID,
        SUBJECT,
      } = itemData || {};

      let finder =
        REGION == params.Region &&
        PRODUCT == params.Product &&
        DOMESTIC_CUSTOMER_GROUP == params.Domestic_Customr_Group;

      return finder;
    });
  }

  var days = [];

  const avgColumn = {
    caption: `Average Demand`,
    cssClass: "cell-disabled",
    minWidth: 116,
    calculateCellValue: function (rowData) {
      if (rowData?.SUBJECT == subjects?.Override) {
        return null;
      }
      let avg = 0;
      let count = 0;
      for (let key in rowData) {
        if (key?.includes("DAY_") && rowData[key]) {
          avg += rowData[key];
          count += 1;
        }
      }
      let average = avg / count;
      return average ? average?.toPrecision(2) : null;
    },
  };
  function addMissingCols(list) {
    if (list[0]) {
      for (let key in list[0]) {
        if (key?.includes("DAY_")) {
          let newObj = {
            caption: key.split("_")[1],
            dataField: key,
            minWidth: 30,
          };
          days.push(newObj);
        }
      }

      let cols = overrideGrid.option("columns");
      overrideGrid.option("columns", [...cols, ...days, avgColumn]);
    }
  }
  function formatList(list) {
    let finalForecastList = list
      ?.filter(
        (obj) =>
          obj?.SUBJECT == subjects.Forecasted &&
          obj?.FORECAST_LEVEL == forecastLevels[0]
      )
      ?.map((obj) => {
        let newObj = { ...obj, SUBJECT: subjects.FinalForecast };
        for (let key in newObj) {
          if (key?.includes("DAY_")) {
            const overrideValue = list?.find(
              (finder) =>
                finder?.SUBJECT == subjects.Override &&
                finder?.PRODUCT == obj?.PRODUCT &&
                finder?.DOMESTIC_CUSTOMER_GROUP ==
                  obj?.DOMESTIC_CUSTOMER_GROUP &&
                finder?.REGION == obj?.REGION
            )?.[key];
            newObj[key] = overrideValue ?? newObj[key];
          }
        }
        return newObj;
      });
    list = list?.concat(finalForecastList);
    return list;
  }
  let currentDay = new Date().getDate();

  let overrideChanged = false;
  function toggleOverrideChangesStatus({ isChanged }) {
    overrideChanged = isChanged;
    $("#update-sap").prop("disabled", isChanged);
  }
  var overrideGrid = $("#gridContainer")
    .dxDataGrid({
      // keyExpr: 'CUSTOMER_ID',
      keyExpr: [
        "CUSTOMER_ID",
        "SUBJECT",
        "FORECAST_LEVEL",
        "DOMESTIC_CUSTOMER_GROUP",
        "REGION",
        "PRODUCT",
      ],
      showBorders: true,
      // dataSource: (response?.data),
      columnAutoWidth: true,
      editing: {
        mode: "cell",
        allowUpdating: function (e) {
          const subject = e.row.data.SUBJECT;
          return subject === subjects.Override;
        },
      },
      paging: { enabled: false },
      onCellPrepared: function (e) {
        if (e.rowType === "data") {
          let { dataField, name, caption } = e.column || {};
          if (
            dataField?.includes("DAY_") &&
            (e?.row?.data.SUBJECT == subjects.Forecasted ||
              e?.row?.data.SUBJECT == subjects.FinalForecast ||
              (+caption < currentDay && !isPlanningMonth))
          ) {
            // e.cellElement.addClass("cell-disabled");
            e.cellElement.css({ backgroundColor: "#fff" });
          } else if (
            dataField?.includes("DAY_") &&
            e?.row?.data.SUBJECT == subjects.Override
          ) {
            e.cellElement.css({ backgroundColor: "#fff2cc" });
          }
          if (
            dataField?.includes("DAY_") &&
            e?.row?.data.SUBJECT == subjects.FinalForecast
          ) {
            e.cellElement.css({ backgroundColor: "#c6f0ff" });
          }
          if (e.column.caption?.includes("Average Demand")) {
            e.cellElement.addClass("text-center");
          }
        }
      },
      onEditorPreparing(e) {
        if (isPlanningMonth) return;
        let { component, row, caption, disabled, element } = e;
        if (row?.data?.SUBJECT == subjects.Override) {
          e.cancel = +caption < currentDay;
        }
      },
      onRowUpdated(e) {
        if (e.key.SUBJECT === subjects.Override) {
          toggleOverrideChangesStatus({ isChanged: true });
          const editColumnName = e.component.option("editing.editColumnName");
          // let list = overrideGrid.option("dataSource");

          const finalForecastKey = {
            ...e.key,
            FORECAST_LEVEL: forecastLevels[0],
            SUBJECT: subjects.FinalForecast,
          };
          const finalForecastRowIndex =
            e.component.getRowIndexByKey(finalForecastKey);

          e.component.cellValue(
            finalForecastRowIndex,
            editColumnName,
            e.data[editColumnName]
          );
          e.component.saveEditData();
        }
      },
      // repaintChangesOnly: true,
      columns: [
        {
          dataField: "CUSTOMER_NAME",
          cellTemplate: function (container, options) {
            var rowIndex = options.rowIndex;
            var currentCustomer = options.data.CUSTOMER_NAME;
            var previousRowData =
              options.component.getVisibleRows()[rowIndex - 1]?.data;
            var isFirst = previousRowData
              ? previousRowData.CUSTOMER_NAME !== currentCustomer
              : true;

            var rowspan = 1;
            if (isFirst) {
              for (
                var i = rowIndex + 1;
                i < options.component.getVisibleRows().length;
                i++
              ) {
                var nextRowData = options.component.getVisibleRows()[i].data;
                if (nextRowData.CUSTOMER_NAME === currentCustomer) {
                  rowspan++;
                } else {
                  break;
                }
              }
            }

            container.attr("style", "text-align: center");
            container.text(options.data.CUSTOMER_NAME);

            if (isFirst) {
              container.attr("rowspan", rowspan);
              container.attr(
                "style",
                "text-align: center; vertical-align: middle;"
              );
            } else {
              container.attr("style", "display: none;");
            }
          },
        },
        {
          caption: "FORECAST",
          calculateCellValue: function (data) {
            if (data.SUBJECT === subjects.Forecasted) {
              return data.SUBJECT + " (" + data.FORECAST_LEVEL + ")";
            } else {
              return data.SUBJECT;
            }
          },
        },
      ],
    })
    .dxDataGrid("instance");

  $("#clear-override").click(() => clearOverride());
  $("#save-override").click(() => saveOverride());
  $("#update-sap").click(() => updateSAP());
  $("#run-forecast-btn").click(() => runForecast());

  function clearOverride() {
    let newData = overrideGrid.option("dataSource");
    newData = newData?.map((obj) => {
      let newObj = { ...obj };
      let forecastValue = 0;

      if (newObj?.SUBJECT === subjects.FinalForecast)
        forecastValue = newData?.find(
          (finder) =>
            finder?.CUSTOMER_ID == obj?.CUSTOMER_ID &&
            finder?.SUBJECT == subjects.Forecasted
        );

      // if (newObj?.SUBJECT === subjects.Override) {
      for (let key in newObj) {
        if (key?.includes("DAY_")) {
          newObj[key] =
            newObj?.SUBJECT === subjects.Override
              ? null
              : newObj?.SUBJECT === subjects.FinalForecast
              ? forecastValue[key]
              : newObj[key];
        }
      }
      // }
      return newObj;
    });
    overrideGrid.option("dataSource", newData);
    // dataGrid.option('dataSource', InitialData);
  }
  async function saveOverride() {
    try {
      let forecastLevel = forecastLevels[0];
      let data = overrideGrid.option("dataSource");

      // final forecast keep only active forecast level dropdown value
      data = data?.filter((obj) => {
        return obj?.SUBJECT == subjects.FinalForecast &&
          obj?.FORECAST_LEVEL !== forecastLevel
          ? false
          : true;
      });
      let FORECAST_LEVEL = forecastLevels[0];
      let status = [{ FORECAST_LEVEL }];
      if (response?.status?.[0]) {
        status = [{ ...response.status[0], FORECAST_LEVEL }];
      }
      var finalJson = JSON.stringify({ data, status });
      let resp = await sendRequest(
        saveOverrideUrl,
        (method = "POST"),
        finalJson
      );

      let newStatus = resp?.status?.[0] || {};
      setStatus(newStatus);

      toggleOverrideChangesStatus({ isChanged: false });
    } catch (error) {
      console.log("saveOverride error", error);
    }
  }
  async function updateSAP() {
    try {
      let forecastLevel = forecastLevels[0];
      let data = overrideGrid.option("dataSource");

      // final forecast keep only active forecast level dropdown value
      data = data?.filter((obj) => {
        return obj?.SUBJECT == subjects.FinalForecast &&
          obj?.FORECAST_LEVEL !== forecastLevel
          ? false
          : true;
      });
      let FORECAST_LEVEL = forecastLevels[0];
      let status = [{ FORECAST_LEVEL }];
      if (response?.status?.[0]) {
        status = [{ ...response.status[0], FORECAST_LEVEL }];
      }
      var finalJson = JSON.stringify({ data, status });
      let resp = await sendRequest(updateSapUrl, (method = "POST"), finalJson);
      let newStatus = resp?.status?.[0] || {};
      setStatus(newStatus);
    } catch (error) {
      console.log("updateSAP error", error);
    }
  }
  async function runForecast() {
    try {
      let resp = await sendRequest(runForecastUrl, (method = "GET"), "");
      handleResp(resp);
    } catch (error) {}
  }

  async function sendRequest(url, method, data) {
    const d = $.Deferred();

    if (data === undefined) {
      data = "";
    }
    var myToken = await sasgetCSRFToken();

    $.ajax(url, {
      method,
      data,
      // xhrFields: { withCredentials: false },
      contentType: "application/json",
      cache: false,
      beforeSend: function (xhr) {
        xhr.setRequestHeader("X-CSRF-Token", myToken);
        xhr.setRequestHeader("X-CSRF-Header", "X-CSRF-Token");
        $(".overlay").show();
      },
      complete: (xhr, status) => {
        $(".overlay").hide();
      },
    })
      .done((result) => {
        d.resolve(method === "POST" ? result : result);
      })
      .fail((xhr) => {
        d.reject(xhr.responseJSON ? xhr.responseJSON.Message : xhr.statusText);
      });
    return d.promise();
  }

  async function sasgetCSRFToken() {
    const csrfURL = `${baseurl}/csrf`;
    const csrfParameters = { method: "GET", credentials: "include" };
    const csrfRequest = await fetch(csrfURL, csrfParameters);
    const csrfToken = await csrfRequest.headers.get("X-CSRF-TOKEN");
    return csrfToken;
  }
});
